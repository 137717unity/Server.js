#!/usr/bin/env node
/*! @license ©2013 Ruben Verborgh - Multimedia Lab / iMinds / Ghent University */

/** Standalone Linked Data Fragments Server */

var fs = require('fs'),
    cluster = require('cluster'),
    LinkedDataFragmentsServer = require('../lib/LinkedDataFragmentsServer');

// Parse arguments
var args = process.argv.slice(2);
if (args.length < 1 || args.length > 3 || /^--?h(elp)?$/.test(args[0])) {
  console.log('usage: server config.json [port [workers]]');
  return process.exit(1);
}
var configFile = args[0],
    config = JSON.parse(fs.readFileSync(configFile)),
    port = parseInt(args[1], 10) || 3000,
    workers = parseInt(args[2], 10) || 1;

// Start up a cluster master if necessary
if (cluster.isMaster && workers > 1) {
  // Create workers
  console.log('Starting cluster');
  for (var i = 0; i < workers; i++)
    cluster.fork();
  cluster.on('exit', function (worker) {
    console.log('worker', worker.process.pid, 'exited');
  });
}
// Start up a worker otherwise
else {
  // Create datasources
  var datasources = config.datasources;
  for (var datasourceName in config.datasources) {
    var datasourceConfig = config.datasources[datasourceName];
    if (datasourceConfig.enabled !== false) {
      try {
        var constructor = require('../lib/datasources/' + datasourceConfig.type),
            datasource = createInstance(constructor, datasourceConfig.settings || []);
        datasources[datasourceName].datasource = datasource;
      }
      catch (error) {
        datasourceConfig.enabled = false;
        process.stderr.write('Could not load datasource ' + datasourceName + ': ' + error.message + '\n');
      }
    }
  }

  // Set up fragment routing
  var fragmentRouters = ['Datasource', 'TriplePattern', 'Page'].map(function (routerName) {
    var Router = require('../lib/routers/' + routerName + 'Router');
    return new Router({ prefixes: config.prefixes });
  });

  // Create and start server
  var server = new LinkedDataFragmentsServer({
    datasources: datasources,
    fragmentRouters: fragmentRouters,
    writers: {
      'text/html,*/*': new require('../lib/writers/HtmlWriter')(config),
      'text/turtle,text/n3': new require('../lib/writers/TurtleWriter')(config),
    },
    prefixes: config.prefixes,
  });
  server.listen(port);
  console.log('Worker', process.pid, 'running on http://localhost:' + port + '/');

  // Terminate gracefully if possible
  process.once('SIGINT', function () {
    console.log('Stopping worker', process.pid);
    process.on('SIGINT', function () { process.exit(1); });
    server.stop();
  });
}

// Creates an instance without the `new` keyword
function createInstance(constructor, constructorArguments) {
  function Constructor() { return constructor.apply(this, constructorArguments); }
  Constructor.prototype = constructor.prototype;
  return new Constructor();
}
