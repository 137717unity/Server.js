<% /*! @license ©2013 Ruben Verborgh - Multimedia Lab / iMinds / Ghent University */ -%>
<div resource="/<%= dataset %>" typeof="void:Dataset hydra:Collection">
<h2>Data source <a href="/<%= dataset %>"><em class="dataset"><%= dataset %></em></a></h2>

<form action="?" method="GET" property="hydra:search" resource="/<%= dataset %>#triplePattern">
  <fieldset resource="/<%= dataset %>#triplePattern">
    <legend>Query <em class="dataset"><%= dataset %></em> by triple pattern</legend>
    <ul>
<% ['subject', 'predicate', 'object'].forEach(function (component) { -%>
      <li property="hydra:mapping" resource="#<%= component %>">
        <label for="<%= component %>"
               about="#<%= component %>" property="hydra:variable" lang=""><%= component %></label>
       <input class="uri" id="<%= component %>" name="<%= component %>"
              about="#<%= component %>" property="hydra:property" resource="rdf:<%= component %>" <%
            %> value="<%= query[component] || '' %>" />
      </li>
<% }); -%>
    </ul>
  </fieldset>
  <p>
    <input type="submit" value="Find matching triples" />
  </p>
</form>
</div>

<h3>Matches in <em class="dataset"><%= dataset %></em> for
  <em class="pattern">{<% -%>
    <%= pattern.subject              ? '<' + pattern.subject   + '>' : '?s' -%>
    <%= pattern.predicate            ? '<' + pattern.predicate + '>' : '?p' -%>
    <%= N3Util.isUri(pattern.object) ? '<' + pattern.object    + '>' : (pattern.object || '?o') -%>
  }</em>
</h3>
<%
  var start = (page - 1) * limit + 1,
      end = Math.min((page) * limit, totalCount),
      hasPrev = page > 1,
      hasNext = totalCount > end,
      subject = query.subject,
      predicate = query.predicate, object = query.object,
      currentUrl = '?subject='   + (subject   ? encodeURIComponent(subject)   : '') +
                   '&predicate=' + (predicate ? encodeURIComponent(predicate) : '') +
                   '&object='    + (object    ? encodeURIComponent(object)    : ''),
      firstUrl = currentUrl + '&page=1',
      prevUrl  = currentUrl + '&page=' + (page - 1),
      nextUrl  = currentUrl + '&page=' + (page + 1);
  if (start <= totalCount) {
%>
<div class="counts">
  Showing triples <%= formatNumber(start) %> to <%= formatNumber(end) %> of
  <%= totalCount === end ? '' : '±'
  %><span property="void:triples hydra:totalItems" datatype="xsd:integer" content="<%= totalCount %>"><%=
    formatNumber(totalCount)
  %></span>
  with <span property="hydra:itemsPerPage" datatype="xsd:integer" content="<%= limit %>"><%=
    formatNumber(limit)
  %></span> triples per page.
  <% if (hasPrev || hasNext) { %>
  <ul class="links">
    <% if (hasPrev) { %>
    <li><a href="<%= firstUrl %>" rel="first" property="hydra:firstPage">first</a></li>
    <li><a href="<%= prevUrl %>" rel="prev" property="hydra:previousPage">previous</a></li>
    <% } %>
    <% if (hasNext) { %>
    <li><a href="<%= nextUrl %>" rel="next" property="hydra:nextPage">next</a></li>
    <% } %>
  </ul>
  <% } %>
</div>
<% } %>
<ul class="triples">
<% triples.forEach(function (triple) {
    var subject = triple.subject, predicate = triple.predicate, object = triple.object;
-%>
    <li>
      <a href="?subject=<%= encodeURIComponent(subject) %>"><%
        %><abbr title="<%= subject %>"><%= shorten(subject) %></abbr><%
      %></a>
      <a href="?predicate=<%= encodeURIComponent(predicate) %>"><%
        %><abbr title="<%= predicate %>"><%= shorten(predicate) %></abbr><%
      %></a>
      <% if (!N3Util.isLiteral(object)) { -%>
      <a href="?object=<%= encodeURIComponent(object) %>" resource="<%= subject %>"><%
        %><abbr title="<%= object %>" property="<%= predicate %>" resource="<%= object %>"><%=
          shorten(object)
        %></abbr></a>.
      <% } else {
        var type = N3Util.getLiteralType(object),
            language = N3Util.getLiteralLanguage(object);
      -%>
      <a href="?object=<%= encodeURIComponent(object) %>" resource="<%= subject %>"><%
        %>"<span property="<%= predicate %>" <%
                if (!language) { %>datatype="<%= type %>"<% }
                else { %>lang="<%= language %>" xml:lang="<%= language %>"<% } %>><%=
          N3Util.getLiteralValue(object)
        %></span>"</a>.
      <% } %>
    </li>
<% }); -%>
</ul>

<ul class="links">
  <% if (hasPrev) { %>
  <li><a href="<%= firstUrl %>" rel="first" property="hydra:firstPage">first</a></li>
  <li><a href="<%= prevUrl %>" rel="prev" property="hydra:previousPage">previous</a></li>
  <% } %>
  <% if (hasNext) { %>
  <li><a href="<%= nextUrl %>" rel="next" property="hydra:nextPage">next</a></li>
  <% } %>
</ul>
<%
function shorten(entity) {
  return entity.match(/([^\/#]*)[\/#]?$/)[1] || entity;
}

function formatNumber(number) {
  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
-%>
