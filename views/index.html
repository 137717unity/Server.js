<% /*! @license Â©2013 Ruben Verborgh - Multimedia Lab / iMinds / Ghent University */ -%>
<% inherits('base') %>
<%
var rdf  = 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
    rdfs = 'http://www.w3.org/2000/01/rdf-schema#',
    dc   = 'http://purl.org/dc/terms/',
    voID = 'http://rdfs.org/ns/void#';
%>

<% var hasQuery = Object.keys(query).length === 0; %>
<% if (hasQuery) { %>
  <h2>Data sources</h2>
  <p>This Linked Data Fragments server offers the following datasets:</p>
  <% queryResult -> result -%>
  <%
    var datasources = {};
    result.triples.forEach(function (triple) {
      var id = triple.subject.match(/[\-a-z_]+$/i)[0],
          datasource = datasources[id] || (datasources[id] = {});
      datasource[triple.predicate] = triple.object;
    });
    var ids = Object.keys(datasources).filter(
      function (id) { return datasources[id][rdf + 'type'] === voID + 'Dataset'; });
  %>
  <ul class="datasets">
    <% ids.forEach(function (id) {
        var datasource = datasources[id]; %>
        <li>
          <span class="name">
            <a href="<%= id %>"><%= decode(datasource[rdfs + 'label']) %></a>
          </span>
          <% if (datasource[dc + 'description']) { %>
            <span class="description"><%= decode(datasource[dc + 'description']) %></span>
          <% } %>
        </li>
    <% }) %>
  </ul>
  <% <- -%>
  <hr>
<% } %>

<%
  function decode(literal) {
    return literal.match(/^"(.+)"/)[1];
  }
%>

<%- render('fragment') %>
